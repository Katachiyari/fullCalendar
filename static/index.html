<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>DevOps Calendar</title>
        <!-- Bootstrap 5.3 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />

        <!-- FullCalendar v6 (JS global builds) -->
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.17/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.17/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.17/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.17/index.global.min.js"></script>

        <style>
            html,
            body {
                height: 100%;
            }
            body {
                display: flex;
                flex-direction: column;
            }
            #calendar {
                flex: 1;
            }
        </style>
    </head>
    <body class="bg-body-tertiary">
        <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
            <div class="container-fluid">
                <span class="navbar-brand">DevOps Calendar</span>
                <div class="text-light small d-none d-md-block">
                    Backend: <code>http://localhost:8000</code>
                </div>
            </div>
        </nav>

        <main class="container py-3">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <span class="fw-semibold">Planning</span>
                            <div class="d-flex gap-2">
                                <button id="openCreateModal" class="btn btn-primary btn-sm" type="button">
                                    Nouvel évènement
                                </button>
                                <button id="refreshBtn" class="btn btn-outline-secondary btn-sm" type="button">
                                    Actualiser
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal Création d'évènement -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">Créer un évènement</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="eventForm" class="row g-3">
                            <div class="col-12">
                                <label for="title" class="form-label">Titre</label>
                                <input type="text" class="form-control" id="title" placeholder="Ex: Déploiement prod" required />
                            </div>

                            <div class="col-md-6">
                                <label for="start" class="form-label">Début</label>
                                <input type="datetime-local" class="form-control" id="start" required />
                            </div>
                            <div class="col-md-6">
                                <label for="end" class="form-label">Fin</label>
                                <input type="datetime-local" class="form-control" id="end" />
                            </div>

                            <div class="col-md-4">
                                <label for="color" class="form-label">Couleur</label>
                                <input type="color" class="form-control form-control-color" id="color" value="#28a745" />
                            </div>

                            <div class="col-md-4">
                                <label for="rrule" class="form-label">Récurrence</label>
                                <select class="form-select" id="rrule">
                                    <option value="">Aucune</option>
                                    <option value="FREQ=DAILY">Tous les jours</option>
                                    <option value="FREQ=WEEKLY">Toutes les semaines</option>
                                    <option value="FREQ=WEEKLY;BYDAY=MO">Tous les lundis</option>
                                    <option value="FREQ=WEEKLY;BYDAY=TU">Tous les mardis</option>
                                    <option value="FREQ=WEEKLY;BYDAY=WE">Tous les mercredis</option>
                                    <option value="FREQ=WEEKLY;BYDAY=TH">Tous les jeudis</option>
                                    <option value="FREQ=WEEKLY;BYDAY=FR">Tous les vendredis</option>
                                    <option value="FREQ=WEEKLY;BYDAY=MO,WE,FR">Lun/Mer/Ven</option>
                                    <option value="FREQ=WEEKLY;BYDAY=TU,TH">Mar/Jeu</option>
                                    <option value="FREQ=MONTHLY">Tous les mois</option>
                                    <option value="FREQ=YEARLY">Tous les ans</option>
                                </select>
                            </div>

                            <div class="col-md-4 form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="all_day" />
                                <label class="form-check-label" for="all_day">Journée entière</label>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Ressources</label>
                                <div class="row g-2" id="resourcesContainer">
                                    <div class="col-auto form-check">
                                        <input class="form-check-input" type="checkbox" value="pod-01" id="res-pod-01" />
                                        <label class="form-check-label" for="res-pod-01">pod-01</label>
                                    </div>
                                    <div class="col-auto form-check">
                                        <input class="form-check-input" type="checkbox" value="pod-02" id="res-pod-02" />
                                        <label class="form-check-label" for="res-pod-02">pod-02</label>
                                    </div>
                                    <div class="col-auto form-check">
                                        <input class="form-check-input" type="checkbox" value="server-01" id="res-server-01" />
                                        <label class="form-check-label" for="res-server-01">server-01</label>
                                    </div>
                                    <div class="col-auto form-check">
                                        <input class="form-check-input" type="checkbox" value="server-db" id="res-server-db" />
                                        <label class="form-check-label" for="res-server-db">server-db</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="2" placeholder="Détails, lien runbook, etc."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" id="saveEventBtn" class="btn btn-primary">Enregistrer</button>
                    </div>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"
        ></script>

        <script>
            const API_BASE = 'http://localhost:8000';

            function getSelectedResources() {
                return Array.from(document.querySelectorAll('#resourcesContainer input[type="checkbox"]:checked')).map(
                    (el) => el.value
                );
            }

            function showToast(message, type = 'danger') {
                const toastHTML = `
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    </div>
                `;
                const toastContainer = document.getElementById('toastContainer') || (() => {
                    const container = document.createElement('div');
                    container.id = 'toastContainer';
                    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                    document.body.appendChild(container);
                    return container;
                })();
                
                const toastEl = document.createElement('div');
                toastEl.innerHTML = toastHTML;
                toastContainer.appendChild(toastEl.firstElementChild);
                
                const toast = new bootstrap.Toast(toastContainer.lastElementChild);
                toast.show();
            }

            function getMinDateTime() {
                // Retourner maintenant + 15 min en heure locale
                const now = new Date();
                now.setMinutes(now.getMinutes() + 15);
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function isEventPast(eventStart) {
                const eventDate = new Date(eventStart);
                return eventDate < new Date();
            }

            async function fetchEvents(fetchInfo, successCallback, failureCallback) {
                try {
                    const res = await fetch(`${API_BASE}/events/`);
                    const data = await res.json();
                    successCallback(data);
                } catch (e) {
                    console.error(e);
                    failureCallback(e);
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                let currentSelection = null;

                const startInput = document.getElementById('start');
                const endInput = document.getElementById('end');

                const calendarEl = document.getElementById('calendar');
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,timeGridDay'
                    },
                    initialView: 'dayGridMonth',
                    selectable: true,
                    editable: true,
                    dayMaxEvents: true,
                    selectMirror: true,
                    events: fetchEvents,
                    eventClick: async function (info) {
                        // Empêcher édition des événements passés
                        if (isEventPast(info.event.start)) {
                            showToast('❌ Impossible de modifier un évènement passé', 'danger');
                            return;
                        }
                        if (confirm(`Supprimer "${info.event.title}" ?`)) {
                            try {
                                const res = await fetch(`${API_BASE}/events/${info.event.id}`, { method: 'DELETE' });
                                if (!res.ok) {
                                    const errData = await res.json();
                                    showToast(`❌ ${errData.detail || 'Erreur de suppression'}`, 'danger');
                                    return;
                                }
                                showToast('✅ Évènement supprimé', 'success');
                                calendar.refetchEvents();
                            } catch (e) {
                                showToast(`❌ ${e.message}`, 'danger');
                            }
                        }
                    },
                    eventDrop: async function (info) {
                        try {
                            const res = await fetch(`${API_BASE}/events/${info.event.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ start: info.event.startStr, end: info.event.endStr || null })
                            });
                            if (!res.ok) {
                                const errData = await res.json();
                                showToast(`❌ ${errData.detail || 'Erreur'}`, 'danger');
                                calendar.refetchEvents();
                                return;
                            }
                            showToast('✅ Évènement déplacé', 'success');
                        } catch (e) {
                            showToast(`❌ ${e.message}`, 'danger');
                            calendar.refetchEvents();
                        }
                    },
                    select: function (info) {
                        currentSelection = info;
                        // Prefill modal fields
                        startInput.value = info.startStr.slice(0, 16);
                        endInput.value = info.endStr ? info.endStr.slice(0, 16) : '';
                        document.getElementById('all_day').checked = info.allDay || false;

                        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                        modal.show();
                    }
                });

                calendar.render();

                // Mettre à jour min datetime au chargement et au focus
                function updateMinDateTime() {
                    const minDt = getMinDateTime();
                    startInput.min = minDt;
                    endInput.min = minDt;
                }
                updateMinDateTime();

                document.getElementById('refreshBtn').addEventListener('click', () => calendar.refetchEvents());
                
                document.getElementById('openCreateModal').addEventListener('click', () => {
                    currentSelection = null;
                    document.getElementById('eventForm').reset();
                    updateMinDateTime();
                    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                    modal.show();
                });

                document.getElementById('saveEventBtn').addEventListener('click', async () => {
                    const title = document.getElementById('title').value.trim();
                    if (!title) {
                        document.getElementById('title').focus();
                        return;
                    }
                    const start = startInput.value;
                    const end = endInput.value || null;
                    const color = document.getElementById('color').value || '#28a745';
                    const rrule = document.getElementById('rrule').value || null;
                    const all_day = document.getElementById('all_day').checked;
                    const description = document.getElementById('description').value || null;
                    const resources = getSelectedResources();

                    try {
                        const res = await fetch(`${API_BASE}/events/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, start, end, color, resources, rrule, all_day, description })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            const detail = errData.detail;
                            if (typeof detail === 'string') {
                                showToast(`❌ ${detail}`, 'danger');
                            } else if (Array.isArray(detail)) {
                                const msg = detail[0]?.msg || 'Erreur de validation';
                                showToast(`❌ ${msg}`, 'danger');
                            } else {
                                showToast('❌ Erreur lors de l\'enregistrement', 'danger');
                            }
                            return;
                        }

                        const modalEl = document.getElementById('eventModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();
                        calendar.unselect();
                        showToast('✅ Évènement créé', 'success');
                        calendar.refetchEvents();
                    } catch (e) {
                        console.error(e);
                        showToast(`❌ ${e.message}`, 'danger');
                    }
                });
            });
        </script>
    </body>
    </html>
